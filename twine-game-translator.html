<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Twine-game-translator</title>
  <link rel="icon" sizes="64x64" type="image/png" href="data:image/png;base64,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">
</head>
<body>

<fieldset>
<details open>
  <summary>Load file</summary>
  <p>
    Orig. v.
    <input type="file" onchange="file_to_dom('game_orig',this)">
    <output id="out_game_orig"></output>
  </p>
  <p>
    Translate v.
    <input type="file" onchange="file_to_dom('game_translat',this)">
    or <input value="Create new" onclick="create_new()" type="button">
    <output id="out_game_translat"></output>    
  <p>
</details>
</fieldset>

<fieldset>
  <legend>Choose passage</legend>
  <input value="Update list" onclick="diff_passage()" type="button">
  <details>
    <summary>All</summary>
    <output id="translat_all"></output>
  </details>
  <details>
    <summary>Diff</summary>
    <output id="translat_none"></output>
  </details>
</fieldset>

<fieldset>
  <legend>Orig. text</legend>
  Pid: <input id="passage_pid" type="number" onchange="passage_get(this.value)" value="" min="1">
  <span id="text_out_error"></span>
  
  <p>Pid: <span id="text_pid"></span></p>
  <p>Name: <span id="text_title"></span></p>
  <div style="border-style: solid; padding: 5px; border-color: #008a77;">
    <pre id="text_out"></pre>
  </div> 
</fieldset>

<fieldset>
  <legend>Translat. text</legend>
  <textarea id="new_text" rows="10" cols="60" style="border-style: solid; padding: 5px; border-color: #008a77;">
  </textarea>
  <input value="Save" onclick="passage_put()" type="button">
</fieldset>

<fieldset>
  <legend>Save to file</legend>
  <input value="File Generation" onclick="save_document()" type="button">
  <a id="file_download"></a>
</fieldset>

<script>
function file_to_dom(name, input) {
  let out_result = document.getElementById("out_" + name);
  out_result.innerHTML = "";

  let file = input.files[0];
  let reader = new FileReader();
  reader.readAsText(file);
  reader.onload = function() {
    window[name] = new DOMParser().parseFromString( reader.result, "text/html");
    is_format(name);
    out_result.innerHTML = '<span style="color:green;">' + file.name + 
                              " loaded successfully</span>";
  };
  reader.onerror = function() {
    out_result.innerHTML = '<span style="color:red;">' + reader.error + "</span>";
  };
}

function create_new(){
  window['game_translat'] = window['game_orig'];
  document.getElementById("out_game_translat").innerHTML = 
    '<span style="color:green;">Create successfully</span>';
}

function is_format(name){
  var d = window[name].querySelector('tw-storydata');
  if( d == null ){
    alert("No storydata found");
  }else{
    if( d.getAttribute("format") != "SugarCube" ) alert("Story format is not supported"); 
  }
}

function diff_passage(){
  if( typeof(window['game_orig']) == "undefined") return;
  var game_orig = window['game_orig'].querySelectorAll('tw-passagedata');
  var gt = window['game_translat'];
  var translat_all = "";
  var translat_none = "";

  for(var passage in game_orig){
    var og = game_orig[passage];
    if( typeof(og) == "function" || typeof(og) == "number") continue;
    
    var pid = og.getAttribute("pid");
    var z = gt.querySelector('tw-passagedata[pid="' + pid + '"]');
    if( z == null){
      console.log(og);
      alert("Stories have differences!\nProcessing stopped.\npid: " + pid);
      break;
    }else{
      translat_all += pid + ", ";
      if( og.textContent == z.textContent ) translat_none += pid + ", ";
    }
  }
  document.getElementById("translat_all").textContent = translat_all;
  document.getElementById("translat_none").textContent = translat_none;
}


function passage_get(pid){
  var gt = window['game_translat'];
  if( typeof(window['game_translat']) == "undefined") return;
  let err_msg = document.getElementById("text_out_error");
  err_msg.innerHTML = "";
  
  document.getElementById("text_pid").textContent = pid;
  var el = gt.querySelector('tw-passagedata[pid="' + pid + '"]');
  if(el === null){
    console.log("error: " + pid);
  }else{
    document.getElementById("text_title").textContent = el.getAttribute("name");
    document.getElementById("text_out").textContent = el.textContent;
  }
}

function passage_put(){  
  var pid = document.getElementById("passage_pid").value;
  var new_text = document.getElementById("new_text").value;
  window['game_translat'].querySelector('tw-passagedata[pid="' + pid + '"]').textContent = new_text;
}

function save_document(){
  var game_str = '<!DOCTYPE html>\n<html data-init="no-js">\n' +
                window['game_translat'].documentElement.innerHTML +
                '</html>';
  var a = document.getElementById("file_download");
  a.download = "game.html";
  a.href = "data:text/html;charset=utf-8," + encodeURIComponent( game_str );
  a.textContent = "file download";
}
</script>
</body>
</html>
